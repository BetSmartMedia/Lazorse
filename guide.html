
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Guide &mdash; Lazorse 0.6.2 documentation</title>
    
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/bsm.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '0.6.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/waypoints.min.js"></script>
    <script type="text/javascript" src="_static/sidebar.js"></script>
    <link rel="top" title="Lazorse 0.6.2 documentation" href="index.html" />
    <link rel="next" title="API documentation" href="api.html" />
    <link rel="prev" title="Lazorse!" href="index.html" /> 
  </head>
  <body>  
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Guide</a><ul>
<li><a class="reference internal" href="#creating-an-app">Creating an App</a></li>
<li><a class="reference internal" href="#routing">Routing</a></li>
<li><a class="reference internal" href="#coercions">Coercions</a></li>
<li><a class="reference internal" href="#handler-and-coercion-contexts">Handler and coercion contexts</a></li>
<li><a class="reference internal" href="#rendering">Rendering</a></li>
<li><a class="reference internal" href="#error-handling">Error handling</a></li>
<li><a class="reference internal" href="#including-example-requests">Including Example Requests</a></li>
</ul>
</li>
</ul>
<h3>Project Links</h3>
<ul>

<li><a href="http://github.com/BetSmartMedia/Lazorse">Source on Github</a></li>
<li><a href="http://github.com/BetSmartMedia/Lazorse/tree/master/examples">Example Apps</a></li>

</ul><h3>Brought to you by:</h3>
<p class="logo"><a href="index.html">
  <img class="logo" src="_static/logo.png" alt="Logo"/>
</a></p>
        </div>
      </div> 

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="guide">
<h1>Guide<a class="headerlink" href="#guide" title="Permalink to this headline">¶</a></h1>
<p>In this document we walk through the features of Lazorse, using it to create a
simple API to store and retrieve language specific greetings. The full app can be
viewed at <a class="reference external" href="https://github.com/BetSmartMedia/Lazorse/blob/master/examples/languages.coffee">https://github.com/BetSmartMedia/Lazorse/blob/master/examples/languages.coffee</a>.</p>
<div class="section" id="creating-an-app">
<h2>Creating an App<a class="headerlink" href="#creating-an-app" title="Permalink to this headline">¶</a></h2>
<p>Lazorse uses a &#8220;builder&#8221; pattern for creating app objects. You supply the function exported by Lazorse with a callback, and it runs that callback in the context of a newly created <a class="reference internal" href="api.html#lazorse::LazyApp" title="lazorse::LazyApp"><tt class="xref coffee coffee-class docutils literal"><span class="pre">LazyApp</span></tt></a> instance. So most apps end up looking something like this:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre><span class="nv">lazorse = </span><span class="nx">require</span> <span class="s">&#39;lazorse&#39;</span>
<span class="nx">lazorse</span> <span class="o">-&gt;</span>
  <span class="c1"># Various LazyApp methods here</span>
</pre></div>
</div>
<p>(This pattern is lifted from Zappa, which lifted it from Sinatra and/or Rack)</p>
</div>
<div class="section" id="routing">
<h2>Routing<a class="headerlink" href="#routing" title="Permalink to this headline">¶</a></h2>
<p>The most unusual piece of lazorse is the routing syntax: it&#8217;s the same as the
<a class="reference external" href="http://tools.ietf.org/html/draft-gregorio-uritemplate-08">draft spec</a> for URI templates, but adds parameter matching
semantics on top. (<a class="reference internal" href="matching_semantics.html#uri-template-matching"><em>Details and disclaimers</em></a>).</p>
<p>You declare routes to resources using the <a class="reference internal" href="api.html#lazorse::LazyApp.resource" title="lazorse::LazyApp.resource"><tt class="xref coffee coffee-meth docutils literal"><span class="pre">LazyApp.resource</span></tt></a> method:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre><span class="nx">lazorse</span><span class="p">.</span><span class="nx">server</span> <span class="nv">port: </span><span class="mi">3001</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">greetingLookup = english: </span><span class="s">&quot;Hi&quot;</span><span class="p">,</span> <span class="nv">french: </span><span class="s">&quot;Salut&quot;</span>

  <span class="c1"># This defines a resource that accepts both GET and POST</span>
  <span class="nx">@resource</span> <span class="s">&quot;/greeting/{language}&quot;</span><span class="o">:</span>
    <span class="nv">description: </span><span class="s">&quot;Per-language greetings&quot;</span>
    <span class="nv">shortName: </span><span class="s">&#39;localGreeting&#39;</span>
    <span class="nv">GET: </span> <span class="o">-&gt;</span> <span class="nx">@ok</span> <span class="nv">greeting: </span><span class="nx">greetingLookup</span><span class="p">[</span><span class="nx">@language</span><span class="p">],</span> <span class="nv">language: </span><span class="nx">@language</span>
    <span class="nv">POST: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">greeting</span>
        <span class="nx">greetingLookup</span><span class="p">[</span><span class="nx">@language</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">greeting</span>
        <span class="nx">@ok</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@error</span> <span class="s">&#39;InvalidParameter&#39;</span><span class="p">,</span> <span class="s">&#39;greeting&#39;</span><span class="p">,</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">greeting</span>
</pre></div>
</div>
<p>All of the keys are optional, but chances are you want to include at least one
HTTP method handler, or your resource will be unreachable. The handlers are
called with <tt class="docutils literal"><span class="pre">this</span></tt> set to a special context that contains all of the matched
URI template parameters and a few other things (see
<a class="reference internal" href="#handler-and-coercion-contexts"><em>Handler and coercion contexts</em></a> below for details)</p>
<p>Lazorse also creates a default index (<tt class="docutils literal"><span class="pre">/</span></tt>) resource. This resource responds to
GET with an array of all named resources with their URI template and other
metadata, such as a description and examples if they are available. So our app
will return an array that looks like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">[</span>
  <span class="p">{</span>
    <span class="s2">&quot;template&quot;</span><span class="o">:</span> <span class="s2">&quot;/{language}/greetings&quot;</span><span class="p">,</span>
    <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Per-language greetings&quot;</span><span class="p">,</span>
    <span class="s2">&quot;shortName&quot;</span><span class="o">:</span> <span class="s2">&quot;localGreeting&quot;</span><span class="p">,</span>
    <span class="s2">&quot;methods&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<p>A resource with no <tt class="docutils literal"><span class="pre">shortName</span></tt> property will <em>not</em> show up in the index.</p>
</div>
<div class="section" id="coercions">
<span id="id1"></span><h2>Coercions<a class="headerlink" href="#coercions" title="Permalink to this headline">¶</a></h2>
<p><cite>Coercions are a direct rip-off of the app.param() functionality of Express</cite></p>
<p>Coercion callbacks can be added anywhere in your app using the
<a class="reference internal" href="api.html#lazorse::LazyApp.coerce" title="lazorse::LazyApp.coerce"><tt class="xref coffee coffee-meth docutils literal"><span class="pre">LazyApp.coerce</span></tt></a> method. The coercion will be called if a URI
template matches <tt class="docutils literal"><span class="pre">req.url</span></tt> and captures a parameter of the same name. This
example adds a coercion to our greeting app that will restrict the <tt class="docutils literal"><span class="pre">language</span></tt>
parameter to only pre-defined languages:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre>  <span class="nx">@coerce</span> <span class="s">&quot;language&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">    A language to use for localized greetings.</span>
<span class="s">    Valid values: </span><span class="si">#{</span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">greetingLookup</span><span class="p">).</span><span class="nx">join</span><span class="p">(</span><span class="s">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s">.</span>
<span class="s">  &quot;&quot;&quot;</span><span class="p">,</span> <span class="nf">(language, next) -&gt;</span>
    <span class="nv">language = </span><span class="nx">language</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="nx">unless</span> <span class="nx">greetingLookup</span><span class="p">[</span><span class="nx">language</span><span class="p">]</span>
      <span class="nv">errName = </span><span class="nx">@req</span><span class="p">.</span><span class="nx">method</span> <span class="o">is</span> <span class="s">&#39;GET&#39;</span> <span class="o">and</span> <span class="s">&#39;NotFound&#39;</span> <span class="o">or</span> <span class="s">&#39;InvalidParameter&#39;</span>
      <span class="nx">@error</span> <span class="nx">errName</span><span class="p">,</span> <span class="s">&#39;language&#39;</span><span class="p">,</span> <span class="nx">language</span>
    <span class="k">else</span>
      <span class="nx">next</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">language</span>
</pre></div>
</div>
<p>This example also makes use of <a class="reference internal" href="#named-errors"><em>named errors</em></a>.</p>
</div>
<div class="section" id="handler-and-coercion-contexts">
<span id="id2"></span><h2>Handler and coercion contexts<a class="headerlink" href="#handler-and-coercion-contexts" title="Permalink to this headline">¶</a></h2>
<p>Each handler and coercion is called back in a specially prepared context.</p>
<p>The context is made up of 2 objects in a delegation chain:</p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">An object containing URI Template variables, which delegates to:</p>
</li>
<li><p class="first">A request context object containing:</p>
<ul>
<li><p class="first">All helpers defined for the app using <a class="reference internal" href="api.html#lazorse::LazyApp.helper" title="lazorse::LazyApp.helper"><tt class="xref coffee coffee-meth docutils literal"><span class="pre">LazyApp.helper</span></tt></a>.</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">app</span></tt>: The lazorse app</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">req</span></tt>: The request object from node (via connect)</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">res</span></tt>: The response object from node (via connect)</p>
</li>
<li><p class="first"><tt class="docutils literal"><span class="pre">error</span></tt>: A callback that will return an error to the client.</p>
</li>
<li><dl class="first docutils">
<dt><tt class="docutils literal"><span class="pre">next</span></tt>: A callback that will pass this request to the next middleware</dt>
<dd><p class="first last">in the chain (via connect).</p>
</dd>
</dl>
</li>
</ul>
</li>
</ol>
</div></blockquote>
<p>Because this is a delegation chain, you need to be careful not to mask out helper
names with variable names.</p>
<p>Although the example handlers have taken no parameters, lazorse does pass them
one parameter: this request context. This is meant to enable fat-arrow handlers
in situations where that&#8217;s more convenient.</p>
</div>
<div class="section" id="rendering">
<span id="id3"></span><h2>Rendering<a class="headerlink" href="#rendering" title="Permalink to this headline">¶</a></h2>
<p>Lazorse includes no templating. Instead, rendering is handled as another
middleware in the stack. The default rendering middleware supports JSON and
(very ugly) HTML. It inspects the <tt class="docutils literal"><span class="pre">Accept</span></tt> header to see what the client wants,
and falls back to JSON when it can&#8217;t provide it. You can easily add or override
the renderer for a new content type like so:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre>  <span class="c1"># Uses https://github.com/visionmedia/consolidate.js</span>
  <span class="c1"># and a non-standard resource property ``view``</span>
  <span class="nv">consolidate = </span><span class="nx">require</span> <span class="s">&#39;consolidate&#39;</span>
  <span class="nx">@render</span> <span class="s">&#39;text/html&#39;</span><span class="p">,</span> <span class="nf">(req, res, next) -&gt;</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span> <span class="s">&#39;Content-Type&#39;</span><span class="p">,</span> <span class="s">&#39;text/html&#39;</span>
    <span class="nv">engine = </span><span class="nx">req</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">view</span><span class="o">?</span><span class="p">.</span><span class="nx">engine</span> <span class="o">or</span> <span class="s">&#39;swig&#39;</span>
    <span class="nv">path   = </span><span class="nx">req</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">view</span><span class="o">?</span><span class="p">.</span><span class="nx">path</span> <span class="o">or</span> <span class="nx">req</span><span class="p">.</span><span class="nx">resource</span><span class="p">.</span><span class="nx">shortName</span> <span class="o">or</span> <span class="s">&#39;fallback.html&#39;</span>
    <span class="nx">consolidate</span><span class="p">[</span><span class="nx">engine</span><span class="p">]</span> <span class="nx">path</span><span class="p">,</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span> <span class="nf">(err, html) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span> <span class="k">then</span> <span class="nx">next</span> <span class="nx">err</span> <span class="k">else</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="nx">html</span>
</pre></div>
</div>
<p>With this in place, we could add a <tt class="docutils literal"><span class="pre">view</span></tt> property to any resource and have it
rendered to html using a template:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre><span class="c1"># a room with a view</span>
<span class="nx">@resource</span> <span class="s">&#39;/room/{id}&#39;</span><span class="o">:</span>
  <span class="nv">view: </span><span class="p">{</span><span class="nv">engine: </span><span class="s">&#39;eco&#39;</span><span class="p">,</span> <span class="nv">path: </span><span class="s">&#39;room.eco&#39;</span><span class="p">}</span>
  <span class="nv">GET: </span><span class="o">-&gt;</span> <span class="p">...</span>
</pre></div>
</div>
</div>
<div class="section" id="error-handling">
<h2>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>The default error handler middleware will recognize any error with a <tt class="docutils literal"><span class="pre">code</span></tt>
and <tt class="docutils literal"><span class="pre">message</span></tt> property and return an appropriate response.</p>
<p>If an error does not have these properties and the <tt class="docutils literal"><span class="pre">passErrors</span></tt> property of the
app is set to false (the default), a generic 500 response will be returned. If
<tt class="docutils literal"><span class="pre">passErrors</span></tt> is true, then the error will be passed to the next middleware in
the stack.</p>
<p id="named-errors">There is also an <tt class="docutils literal"><span class="pre">&#64;error</span></tt> helper function made available to handlers and
coercions to help with returning errors. It can look up errors by name so that
you don&#8217;t need to manually import your error types if you don&#8217;t want to.</p>
<p>To register a new error type with a callback, we use the
<a class="reference internal" href="api.html#lazorse::LazyApp.error" title="lazorse::LazyApp.error"><tt class="xref coffee coffee-meth docutils literal"><span class="pre">LazyApp.error</span></tt></a> method:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre>  <span class="c1"># named function.</span>
  <span class="k">class</span> <span class="nx">TeapotError</span>
    <span class="nv">constructor: </span><span class="o">-&gt;</span>

  <span class="c1"># and register it with the app</span>
  <span class="nx">@error</span> <span class="nx">TeapotError</span><span class="p">,</span> <span class="nf">(err, req, res, next) -&gt;</span>
    <span class="nv">res.statusCode = </span><span class="mi">418</span>
    <span class="nx">res</span><span class="p">.</span><span class="nx">end</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">      I&#39;m a little teapot, short and stout.</span>
<span class="s">      Here is my handle, here is my spout.</span>
<span class="s">      When I get all steamed up, hear me shout!</span>
<span class="s">      Tip! me over and pour me out!</span>
<span class="s">    &quot;&quot;&quot;</span>

  <span class="nx">@resource</span> <span class="s">&#39;/teapot&#39;</span><span class="o">:</span> <span class="nv">GET: </span><span class="o">-&gt;</span> <span class="nx">@error</span> <span class="s">&#39;TeapotError&#39;</span>
</pre></div>
</div>
<p>Now our handlers (and coercions) can return 418s easily, no matter what file they
are defined in.</p>
</div>
<div class="section" id="including-example-requests">
<h2>Including Example Requests<a class="headerlink" href="#including-example-requests" title="Permalink to this headline">¶</a></h2>
<p>You can include an array of example requests for a named route &#8220;inline&#8221; with the
<tt class="docutils literal"><span class="pre">examples</span></tt> property. Each example should be an object with a <tt class="docutils literal"><span class="pre">method</span></tt>,
<tt class="docutils literal"><span class="pre">vars</span></tt>, and (optional) <tt class="docutils literal"><span class="pre">body</span></tt> property. In our example app that would look
like:</p>
<div class="highlight-coffeescript"><div class="highlight"><pre><span class="nx">lazorse</span><span class="p">.</span><span class="nx">server</span> <span class="nv">port: </span><span class="mi">3001</span><span class="p">,</span> <span class="o">-&gt;</span>
  <span class="nv">greetingLookup = english: </span><span class="s">&quot;Hi&quot;</span><span class="p">,</span> <span class="nv">french: </span><span class="s">&quot;Salut&quot;</span>

  <span class="c1"># This defines a resource that accepts both GET and POST</span>
  <span class="nx">@resource</span> <span class="s">&quot;/greeting/{language}&quot;</span><span class="o">:</span>
    <span class="nv">description: </span><span class="s">&quot;Per-language greetings&quot;</span>
    <span class="nv">shortName: </span><span class="s">&#39;localGreeting&#39;</span>
    <span class="nv">GET: </span> <span class="o">-&gt;</span> <span class="nx">@ok</span> <span class="nv">greeting: </span><span class="nx">greetingLookup</span><span class="p">[</span><span class="nx">@language</span><span class="p">],</span> <span class="nv">language: </span><span class="nx">@language</span>
    <span class="nv">POST: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">greeting</span>
        <span class="nx">greetingLookup</span><span class="p">[</span><span class="nx">@language</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">greeting</span>
        <span class="nx">@ok</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">@error</span> <span class="s">&#39;InvalidParameter&#39;</span><span class="p">,</span> <span class="s">&#39;greeting&#39;</span><span class="p">,</span> <span class="nx">@req</span><span class="p">.</span><span class="nx">body</span><span class="o">?</span><span class="p">.</span><span class="nx">greeting</span>
    <span class="nv">examples: </span><span class="p">[</span>
      <span class="p">{</span><span class="nv">method: </span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="nv">vars: </span><span class="p">{</span><span class="nv">language: </span><span class="s">&#39;english&#39;</span><span class="p">}}</span>
      <span class="p">{</span><span class="nv">method: </span><span class="s">&#39;POST&#39;</span><span class="p">,</span> <span class="nv">vars: </span><span class="p">{</span><span class="nv">language: </span><span class="s">&#39;english&#39;</span><span class="p">},</span> <span class="nv">body: </span><span class="s">&quot;howdy&quot;</span><span class="p">}</span>
    <span class="p">]</span>
</pre></div>
</div>
<p>The route <tt class="docutils literal"><span class="pre">/examples/{shortName}</span></tt> will respond with the example request
expanded into a full URI path, so <tt class="docutils literal"><span class="pre">GET</span> <span class="pre">/examples/localGreeting</span></tt> would return:</p>
<div class="highlight-javascript"><pre>[
    {
      "method": GET",
      "path": "/english/greetings"
    },
    {
      "method": "POST",
      "path": "/english/greetings",
      "body": "howdy"
    }
]</pre>
</div>
</div>
</div>


          </div>
        </div>
      </div> 
      <div class="clearer"></div>
    </div> 
    <div class="footer">
        &copy; Copyright 2011, Stephen Sugden, Judd Vinet.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>